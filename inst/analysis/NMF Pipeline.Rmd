---
title: "NMF Pipeline"
author: "Lucie Chrastecka"
date: "8/30/2021"
output: html_document
editor_options: ]
  chunk_output_type: console
---

LIBRARY
```{r}
#PACKAGES
library(msigdbr)
library(gplots)
library(ggplot2)
library(heatmap.plus)
library(RColorBrewer)
library(biomaRt)
library(wesanderson)
library(readr)
library(FactoMineR)
library(readr)
library(factoextra)
library(dplyr)
library(clusterProfiler)
library(org.Hs.eg.db)
library(org.Mm.eg.db)
library(gridExtra)
library(DESeq2)
library(data.table)
library(pdist)
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
library(qusage)


```


DATA
```{r}

full_Snyder <- ODIS::full_Snyder
full_Snyder$ex <- as.matrix(full_Snyder$ex)
snyder_readcounts <- full_Snyder$ex

row.names(snyder_readcounts) <- full_Snyder$featInfo$ENSEMBL

```


MOUSE ENSEMBL TO MOUSE ENTREZ GENE CONVERSION + MGI SYMBOL
```{r}

SnyderMouseGenes <- full_Snyder$featInfo$ENSEMBL
tmp_snyder <- ODIS::Mouse2Human(SnyderMouseGenes) #need human homologue to run gsea
head(tmp_snyder)
#tmp_snyder <- lapply(tmp_snyder,as.character)
summary(tmp_snyder)
head(tmp_snyder)
str(tmp_snyder)
tmp_snyder <- as.data.frame(tmp_snyder)

full_Snyder$featInfo <- as.data.frame(full_Snyder$featInfo)
full_Snyder$featInfo <- merge(full_Snyder$featInfo, tmp_snyder)
summary(full_Snyder$featInfo)
head(full_Snyder$featInfo)
```

NMF
```{r}
non_zero_matrix <- snyder_readcounts
non_zero_matrix[non_zero_matrix<1] <- 0.1; non_zero_matrix

library(NMF)

set.seed(1234)
snyder_nmf <- nmf(x = non_zero_matrix, rank = 3, method = 'brunet') # if not transposed, runs mmediately, then just take non-trasposed h matrix

w <- t(coef(snyder_nmf))
dim(w)
head(w)

h <- basis(snyder_nmf)
dim(h)
head(h)

saveRDS(h, "./Snyder_NMF.rds")

head(Snyder_NMF)

```

Make GSEA friendly "gene_list"
```{r}
df1 <- Snyder_NMF[,1]
head(df1)
```


ALL MY SETS + CONVERSION OF LIST OF SENTS INTO .GMT FILES
```{r}

C1_df = msigdbr(species = "Mus musculus", category = "C1", subcategory = "")
C2_df = msigdbr(species = "Mus musculus", category = "C2", subcategory = "CGP")
C2KEGG_df = msigdbr(species = "Mus musculus", category = "C2", subcategory = "CP:KEGG")
C3_df = msigdbr(species = "Mus musculus", category = "C3", subcategory = "MIR:MIRDB")
C4_df = msigdbr(species = "Mus musculus", category = "C4", subcategory = "CGN")
C5_df = msigdbr(species = "Mus musculus", category = "C5", subcategory = "BP")
C6_df = msigdbr(species = "Mus musculus", category = "C6", subcategory = "")
C7_df = msigdbr(species = "Mus musculus", category = "C7", subcategory = "IMMUNESIGDB")
C8_df = msigdbr(species = "Mus musculus", category = "H", subcategory = "")

list_of_sets = list(C1 = C1_df,
                    C2 = C2_df,
                    C2_KEGG = C2KEGG_df,
                    C3 = C3_df,
                    C4 = C4_df,
                    C5 = C5_df,
                    C6 = C6_df,
                    C7 = C7_df,
                    C8 = C8_df)

list_of_gmt_files <- ODIS::convert_msigdbr_obj_to_gmt_file(list_of_sets)
```


NMF GSEA
```{r}

gene_list <- df1
head(gene_list, n = 5)

for(i in list_of_gmt_files){
  print(i)
  res <- ODIS::ODISGSEA(gene_list = gene_list, theGoFile = i, pval = 0.05) ## need to structure outputs correctly
}


summary(res)
```

GENE VS GENE SET HEATMAPS
```{r}
ODIS::ODIS.Heatmaps(x)
```
