---
title: "RunMe_NMF.Rmd"
author: "Lucie Chrastecka"
date: "2023-03-24"
output: html_document
editor_options: 
  chunk_output_type: console
---

#This script will run the entirety of the appropriate steps of GeneSetMatch pipeline for Dimensionality Reduction Analysis (NMF, patternMarkers) of a mixed rat Liver, Lung, Brain bulk RNA-Seq dataset. Pathway Enrichment is performed against C5 and C8  MSigDB sets, and visualized with our multimodal heatmaps. 
The heatmaps are very large, and therefore downloading separately from within the knitted html is recomended to preserve resolution and detail.
Assuming all necessary libraries are loaded, the computation should take 10-15 minutes.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
library(biomaRt)
library(NMF)
library(base)
library(pdist)
library(gplots)
library(msigdbr)
library(GeneSetMatch)
library(BBmisc) #for normalize
library(clusterProfiler)
library(AnnotationDbi)
library(org.Rn.eg.db)
library(xfun)
xfun::pkg_load2(c("htmltools", "mime"))
```

DATA - load in liver lung brain dataset
```{r}
LLB <- GeneSetMatch::LLB
summary(LLB)
LLB$ex <- as.matrix(LLB$ex)
str(LLB$ex)
```


NMF - perform 3 vector NMF 
```{r echo=TRUE, results='hide'}
LLB_non_zero_matrix <- LLB$ex
LLB_non_zero_matrix <- as.matrix(LLB_non_zero_matrix)
LLB_non_zero_matrix[LLB_non_zero_matrix<1] <- 0.1; LLB_non_zero_matrix

head(LLB_non_zero_matrix)

set.seed(1234)
LLB_nmf<- nmf(x = LLB_non_zero_matrix, rank = 3, method = 'brunet') # if not transposed, runs immediately, then just take non-transposed h matrix

w <- t(coef(LLB_nmf))
dim(w)
head(w)

h <- basis(LLB_nmf)
dim(h)
head(h)

```

Normalize and make GSEA friendly "gene_list" from NMF Vectors
```{r}
 
 nmf_norm <- BBmisc::normalize(h, method = "range", range = c(0, 1), margin = 1L, on.constant = "quiet")
 head(nmf_norm)
 df1 <- nmf_norm[,1]
 head(df1)

```

Apply PatternMarker Transformation and make GSEA friendly "gene_list"
```{r}
nmf_pm <- GeneSetMatch::transformedPM(h)
head(nmf_pm)

rank <- 3
nmf_tfpm <- (sqrt(rank-1)/2 - nmf_pm)^3
head(nmf_tfpm)
df2 <- nmf_tfpm[,1]
head(df2)
```

Preparing MSigDB Sets and conversions into .gmt files for GSEA
```{r}
C5_df = msigdbr(species = "Rattus norvegicus", category = "C5", subcategory = "BP")
C8_df = msigdbr(species = "Rattus norvegicus", category = "C8", subcategory = "") #update on all

list_of_sets = list(C5 = C5_df,
                    C8 = C8_df)

list_of_gmt_files <- GeneSetMatch::convert_msigdbr_obj_to_gmt_file(list_of_sets)
```

GSEA on all three vectors of NMF +orig values 
```{r echo=TRUE, results='hide'}

#by dropping anything that is negatively enriched (bottom of the NMF vector) we do not consider as a hit. Therefore, we allow GESA  to focus only on the genes on the top of the NMF pile. 
 

LLB<- list()

## Both of the following lists have naming convention "v1","v2", etc, so you can index them in a single for loop by assigning the loop variable as the character string.

## Make list of norm aka raw scores
Q = list(V1 = nmf_norm[,1, drop = F],
         V2 = nmf_norm[,2, drop = F],
         V3 = nmf_norm[,3, drop = F])


## make list of tfpm scores.
new_y = list(V1 = nmf_tfpm[,1, drop = F],
             V2 = nmf_tfpm[,2, drop = F],
             V3 = nmf_tfpm[,3, drop = F])
    
    
for(Y in c("V1","V2","V3") #drop = f MEANS KEEP IT AS A MATRIX WITH COLLUMNS AND
){
  
  ## Make vector sorted gene list of TFPM scores
    X <- new_y[[Y]]
    gene_list = X[,1]
    gene_list = sort(gene_list, decreasing = TRUE)
    gene_list = gene_list[!duplicated(names(gene_list))]
    print("head gene_list")
    head(gene_list, n = 5)
    
    ## Make vector sorted gene list of raw nmf scores
    Z <- Q[[Y]]
    orig_value = Z[,1]
    orig_value = orig_value[!duplicated(names(orig_value))]
    orig_value <- orig_value[match(names(gene_list), names(orig_value))] #SORTED BASED ON GENE_LIST TO MAINTAIN ORDER
    print("head orig_value")
    head(orig_value, n = 5)
    
    head(names(gene_list),n=5)
    
    print(" Are these three things ^^ sorted the same way ??!?!?!?!?!?")
    
    
    for(i in list_of_gmt_files){
      print(i)
      res <- GeneSetMatch::GSMGSEA(gene_list = gene_list, theGoFile = i, pval = 0.1, onlypos = TRUE) #drop to 0.1, onlypos is true because NMF
      LLB[[Y]][[i]] <- res  ## find a way to reference "nmf_norm" and "nmf_norm_org"
    }
    #orig_matrix must be a data frame
    LLB[[Y]]$orig_matrix <- as.data.frame(list(log2FoldChange = orig_value,
                                                                    EnrichmentScore = gene_list,
                                                                    ENTREZID = names(gene_list),
                                                                    SYMBOL = GeneSetMatch::RatENT2RatSYM(names(gene_list)))) #rat conversion function returns some NA's 
    
}

#this^^ is out of order. orix matrix overwrites any collected GSEA reults and then a random data frame gets constructed from irrelevant garbage

summary(LLB)
```


#DE Heatmaps for all .gmt files
```{r echo=TRUE, results='hide'}
#knitr::opts_chunk$set(fig.width=4, fig.height=4) 
  GeneSetMatch::GSM.Multilevel.Rat.Heatmaps(LLB, verbose = FALSE, pdftofile = TRUE, filePrefix = "NMF")
  
```

#Mutlimodal Heatmap for C5 geneset (Very Large)
```{r}
xfun::embed_file('./myC5.gmt.NMF.pdf')
```

#multimodal Heatmap for C8 geneset (Very Large)
```{r}
xfun::embed_file('./myC8.gmt.NMF.pdf')
```
